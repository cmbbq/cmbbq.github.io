+++
title = "Music Signal Processing"
date = "2025-02-06"
tags = ["sys", "music computing"]
description = "总结一些音乐信号处理的基础概念和通用工具（持续更新中）。"
showFullContent = false
+++

## MP3/AAC -> PCM
音频的数字表示多种多样，抖t等平台存储的多媒体数据往往是MP3、AAC、OGG等有损格式，它们基于心理学模型去除人耳不敏感的音频信号从而大幅压缩文件体积[^4]。

这些压缩格式固然对存储、传输友好，但想对它们进行计算，还是需转成PCM。

PCM的数据格式简单，去掉header后就可以将其视作能量[^5]数组（vec<f32>），数组下标即time frames。

## PCM -> STFT -> Spectrogram
PCM音频样本经过短时傅里叶变换（STFT）可得时频图，即spectrogram（vec<vec<float>>）。

STFT将信号分为多个时间窗口，对每个窗口内的信号逐一乘以窗口函数（如汉明窗[^1]），并施加DFT。

STFT的关键参数n_fft（记作$N$）即时间窗口的帧数，其本质是调节频谱分辨率和时间分辨率的参数。将采样率[^2]记为$S$，则$频谱分辨率 = \frac{S}{N}$，$窗口时长 = \frac{N}{S}$。

因此n_fft越高，采样率越高，频率分辨率越高（频段越细）。在语音识别中往往n_fft = 512就够用，在音乐分析中，则往往需要2048才能解析低频声乐，如鼓声、贝斯。

此外，n_fft越高，时间分辨率越低（窗口时长更长，时间定位更不精确），因此语音、打击乐等瞬态信号处理场景更适合用低n_fft。

STFT得到的时频图的频域单位是bin index（频率分量索引，记作$k$），稍作换算即可得到声音的频率$f$(单位Hz)：$f = \frac{k* S}{N}$。

## Spectrogram -> Mel Filter Bank -> Mel Spectrogram
相比的时频图频率轴默认的线性标度，梅尔频率提供了一种更符合人耳频率感知的非线性标度：

构造梅儿滤波器组常见的做法是：
- 确定频率范围，通常为0到奈奎斯特频率（采样率的一半，例如16kHz音频对应8kHz）。
- 根据$M(f) = 2595 \log_{10}(1 + f/700)$将线性刻度映射到梅尔刻度。
- 在梅尔刻度上等间距划分M个频带（如128个[^3]），再转换回线性频率，得到每个频带的中心频率。
- 每个滤波器在频域呈三角形，覆盖相邻中心频率的范围，峰值位于当前频带的中心频率。

将每个三角滤波器与频谱图的能量分布相乘并求和，得到各梅尔频带的能量。最终，每个时间帧的频谱被压缩为M维的梅尔频谱特征。

## Spectrogram -> Hopping -> Overlapping Chunks
小步长重叠切分通过增加时间轴上的匹配候选密度，使系统能够容忍时间偏移(time skew)[^6]。这是音乐检索领域对抗时间对齐问题的经典策略。

一种可行的做法是将mel spectrogram以1/4个chunk size为hop size切分成overlapping chunks，再进行后续处理——可以是某种深度音乐模型，也可以是基于规则的audio fingerprinting。

[^1]: 汉明窗让信号在时域上更平滑，减少窗口边界处的信号突变，让更多能量集中在窗口中心，减少边缘的频谱泄露，缓解栅栏效应。所谓栅栏效应（即频谱泄漏）是在信号处理中由于信号在时域上的截断而导致的频谱分析中频率分辨率不足的现象。
[^2]: 每秒样本数，单位Hz。
[^3]: 128个梅尔频率带对人耳来说，频率分辨率足够，计算负担也不会太高。实际上人耳临界带宽
[^4]: 压缩率可达原始PCM音频的$\frac{1}{10}$~$\frac{1}{12}$。
[^5]: 音频信号语境下，能量即振幅，与响度相关的换算公式是：$L_{db} = 10 \log_{10}(E)$。
[^6]: 所谓time skew（时间偏移）指的是同一段音乐在不同录音或播放中存在的时间上的微小差异，比如同一首歌的不同版本可能开始时间不同，或者在录制时存在延迟，这可能导致直接匹配时无法对齐，从而影响检索的准确性。
